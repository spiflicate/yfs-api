name: CI

# When this workflow runs:
# - On every push to main branch
# - On every pull request to main branch
# - Manually via workflow_dispatch
on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

# Cancel in-progress runs when a new run is triggered
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Job 1: Run linting and formatting checks
  lint:
    name: Lint & Format Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Run Biome lint
        run: bun run lint

      - name: Check formatting
        run: bun run format --check

  # Job 2: TypeScript type checking
  typecheck:
    name: TypeScript Type Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Run type check
        run: bun run type-check

  # Job 3: Run tests with multiple Node.js versions
  test:
    name: Test (Node ${{ matrix.node-version }})
    runs-on: ubuntu-latest
    
    strategy:
      fail-fast: false
      matrix:
        node-version: [18, 20, 22]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Run unit tests
        run: bun test tests/unit

      - name: Generate coverage report
        run: bun test tests/unit --coverage

  # Job 4: Build the package
  build:
    name: Build Package
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Clean previous builds
        run: bun run clean

      - name: Build package
        run: bun run build

      - name: Check build output
        run: |
          if [ ! -d "dist" ]; then
            echo "Error: dist directory not created"
            exit 1
          fi
          if [ ! -f "dist/index.js" ]; then
            echo "Error: dist/index.js not created"
            exit 1
          fi
          if [ ! -f "dist/index.d.ts" ]; then
            echo "Error: dist/index.d.ts not created"
            exit 1
          fi
          echo "âœ… Build output verified"

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist/
          retention-days: 7

  # Job 5: Verify package can be installed
  install-test:
    name: Installation Test
    runs-on: ubuntu-latest
    needs: build
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist/

      - name: Pack package
        run: npm pack

      - name: Create test project
        run: |
          mkdir test-install
          cd test-install
          npm init -y
          npm install ../yfs-api-*.tgz

      - name: Test import
        run: |
          cd test-install
          cat > test.mjs << 'EOF'
          import { YahooFantasyClient } from 'yfs-api';
          console.log('âœ… Package imported successfully');
          console.log('YahooFantasyClient:', typeof YahooFantasyClient);
          if (typeof YahooFantasyClient !== 'function') {
            process.exit(1);
          }
          EOF
          node test.mjs

  # Job 6: All checks passed
  all-checks:
    name: All Checks Passed
    runs-on: ubuntu-latest
    needs: [lint, typecheck, test, build, install-test]
    if: always()
    
    steps:
      - name: Check if all jobs succeeded
        run: |
          if [ "${{ needs.lint.result }}" != "success" ] || \
             [ "${{ needs.typecheck.result }}" != "success" ] || \
             [ "${{ needs.test.result }}" != "success" ] || \
             [ "${{ needs.build.result }}" != "success" ] || \
             [ "${{ needs.install-test.result }}" != "success" ]; then
            echo "âŒ Some checks failed"
            exit 1
          fi
          echo "âœ… All checks passed!"
